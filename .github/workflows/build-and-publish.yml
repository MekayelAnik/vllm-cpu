name: Build and Publish vLLM CPU Wheels

on:
  # Manual workflow trigger
  workflow_dispatch:
    inputs:
      vllm_version:
        description: 'vLLM version to build (e.g., v0.6.2 or commit SHA)'
        required: true
        type: string
      publish_to_pypi:
        description: 'Publish to production PyPI'
        required: true
        type: boolean
        default: false
      publish_to_test_pypi:
        description: 'Publish to Test PyPI'
        required: true
        type: boolean
        default: true
      variants:
        description: 'Variants to build (comma-separated, leave empty for all)'
        required: false
        type: string
        default: ''

  # Automatic trigger on version tags
  push:
    tags:
      - 'v*.*.*'

  # Build on PRs to test (but don't publish)
  pull_request:
    branches:
      - main
      - develop

jobs:
  # Prepare build matrix
  prepare-matrix:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      vllm_version: ${{ steps.set-version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set vLLM version
        id: set-version
        run: |
          # Input validation
          if [ -n "${{ github.event.inputs.vllm_version }}" ]; then
            VERSION="${{ github.event.inputs.vllm_version }}"
          elif [ "${{ github.event_name }}" == "push" ]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            # For PRs, use main
            VERSION="main"
          fi

          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"

          # Validate version format (alphanumeric, dots, hyphens only)
          if ! [[ "$VERSION" =~ ^[a-zA-Z0-9][a-zA-Z0-9._-]*$ ]]; then
            echo "Error: Invalid version format: $VERSION"
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Building vLLM version: $VERSION"

      - name: Set build matrix
        id: set-matrix
        run: |
          # Validate and sanitize variants input
          VARIANTS_INPUT="${{ github.event.inputs.variants }}"

          if [ -n "$VARIANTS_INPUT" ]; then
            # Validate each variant name
            IFS=',' read -ra VARIANTS_ARRAY <<< "$VARIANTS_INPUT"
            VALIDATED_VARIANTS=()

            for variant in "${VARIANTS_ARRAY[@]}"; do
              # Trim whitespace
              variant=$(echo "$variant" | xargs)

              # Validate format: vllm-cpu or vllm-cpu-xxx
              if [[ "$variant" =~ ^vllm-cpu(-[a-z0-9]+)?$ ]]; then
                VALIDATED_VARIANTS+=("\"$variant\"")
              else
                echo "Warning: Skipping invalid variant name: $variant"
              fi
            done

            if [ ${#VALIDATED_VARIANTS[@]} -eq 0 ]; then
              echo "Error: No valid variants provided"
              exit 1
            fi

            # Join array into JSON format
            VARIANTS_JSON=$(IFS=,; echo "[${VALIDATED_VARIANTS[*]}]")
          else
            # Build all variants (hardcoded list for safety)
            VARIANTS_JSON='["vllm-cpu","vllm-cpu-avx512","vllm-cpu-avx512vnni","vllm-cpu-avx512bf16","vllm-cpu-amxbf16"]'
          fi

          echo "matrix={\"variant\":$VARIANTS_JSON}" >> "$GITHUB_OUTPUT"
          echo "Building variants: $VARIANTS_JSON"

  # Build wheels for each variant
  build-wheels:
    name: Build ${{ matrix.variant }}
    needs: prepare-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hours max per variant
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ccache
            /tmp/vllm-build
          key: ${{ runner.os }}-build-${{ matrix.variant }}-${{ needs.prepare-matrix.outputs.vllm_version }}-${{ hashFiles('build_config.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.variant }}-
            ${{ runner.os }}-build-

      - name: Install uv package manager
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-14 g++-14 \
            cmake ninja-build \
            ccache \
            libtcmalloc-minimal4 \
            libnuma-dev \
            numactl \
            jq

          # Set gcc-14 as default
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100 \
            --slave /usr/bin/g++ g++ /usr/bin/g++-14

      - name: Verify build environment
        run: |
          echo "=== Build Environment ==="
          gcc --version
          cmake --version
          ninja --version
          python --version
          uv --version
          jq --version
          echo "========================"

      - name: Validate variant name
        run: |
          VARIANT="${{ matrix.variant }}"
          if ! [[ "$VARIANT" =~ ^vllm-cpu(-[a-z0-9]+)?$ ]]; then
            echo "Error: Invalid variant name: $VARIANT"
            exit 1
          fi
          echo "Building variant: $VARIANT"

      - name: Build wheel for ${{ matrix.variant }}
        run: |
          set -euo pipefail

          # Quote all variables properly
          ./build_wheels.sh \
            --variant="${{ matrix.variant }}" \
            --vllm-version="${{ needs.prepare-matrix.outputs.vllm_version }}" \
            --output-dir="dist" \
            --max-jobs=4 \
            --no-cleanup
        env:
          CCACHE_DIR: ${{ github.workspace }}/.ccache

      - name: List built wheels
        run: |
          echo "Built wheels for ${{ matrix.variant }}:"
          ls -lh dist/*.whl || echo "No wheels found"

      - name: Validate wheel
        run: |
          pip install twine
          if ls dist/*.whl 1> /dev/null 2>&1; then
            twine check dist/*.whl
          else
            echo "Error: No wheels found to validate"
            exit 1
          fi

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.variant }}
          path: dist/*.whl
          retention-days: 30
          compression-level: 0
          if-no-files-found: error

  # Test wheels
  test-wheels:
    name: Test ${{ matrix.variant }}
    needs: [prepare-matrix, build-wheels]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Download wheel artifact
        uses: actions/download-artifact@v4
        with:
          name: wheels-${{ matrix.variant }}
          path: dist/

      - name: Verify wheel downloaded
        run: |
          if ! ls dist/*.whl 1> /dev/null 2>&1; then
            echo "Error: No wheels found in dist/"
            exit 1
          fi
          echo "Found wheels:"
          ls -lh dist/*.whl

      - name: Install wheel
        run: |
          # Install the wheel
          pip install dist/*.whl

      - name: Test import
        run: |
          python -c "import vllm; print(f'vLLM version: {vllm.__version__}')"

      - name: Test basic inference (if small model available)
        if: false  # Disabled by default
        run: |
          python -c "
          from vllm import LLM
          llm = LLM(model='facebook/opt-125m', device='cpu', max_num_batched_tokens=2048)
          output = llm.generate('Hello, my name is', max_tokens=10)
          print(output)
          "

  # Create GitHub Release with wheels
  github-release:
    name: Create GitHub Release
    needs: [prepare-matrix, build-wheels, test-wheels]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.vllm_version != '')

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/
          pattern: wheels-*
          merge-multiple: true

      - name: List wheels for release
        run: |
          echo "=========================================="
          echo "Wheels ready for GitHub Release:"
          echo "=========================================="
          ls -lh dist/*.whl || echo "No wheels found"
          echo ""
          echo "Total wheels: $(ls dist/*.whl 2>/dev/null | wc -l)"
          echo ""

          # Calculate total size
          if ls dist/*.whl 1> /dev/null 2>&1; then
            total_size=$(du -sh dist/ | cut -f1)
            echo "Total size: $total_size"
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          # vLLM CPU Wheels - Version ${{ needs.prepare-matrix.outputs.vllm_version }}

          This release contains 5 CPU-optimized vLLM wheel packages built from upstream vLLM ${{ needs.prepare-matrix.outputs.vllm_version }}.

          ## üì¶ Available Packages

          | Package | Optimizations | Target CPUs |
          |---------|--------------|-------------|
          | `vllm-cpu` | Baseline | All x86_64 and ARM64 CPUs |
          | `vllm-cpu-avx512` | AVX512 | Intel Skylake-X+ |
          | `vllm-cpu-avx512vnni` | AVX512 + VNNI | Intel Cascade Lake+ |
          | `vllm-cpu-avx512bf16` | AVX512 + VNNI + BF16 | Intel Cooper Lake+ |
          | `vllm-cpu-amxbf16` | AVX512 + VNNI + BF16 + AMX | Intel Sapphire Rapids+ |

          ## üöÄ Installation

          **All dependencies are automatically installed** - just install the wheel:

          ```bash
          # Download the .whl file for your CPU, then:
          pip install vllm_cpu_avx512bf16-${{ needs.prepare-matrix.outputs.vllm_version }}-*.whl
          ```

          Or install directly from PyPI:

          ```bash
          pip install vllm-cpu-avx512bf16==${{ needs.prepare-matrix.outputs.vllm_version }}
          ```

          **No additional dependencies needed** - PyTorch, transformers, and all other requirements install automatically!

          ## üìã Build Information

          - **Upstream vLLM**: ${{ needs.prepare-matrix.outputs.vllm_version }}
          - **Built with**: gcc-14, cmake, ninja
          - **Python**: 3.9+
          - **Platform**: linux_x86_64

          ## üîó Links

          - [Upstream vLLM](https://github.com/vllm-project/vllm)
          - [vLLM Documentation](https://docs.vllm.ai/)
          - [PyPI Packages](https://pypi.org/search/?q=vllm-cpu)
          EOF

      - name: Create or Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.whl
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          fail_on_unmatched_files: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Publish to PyPI
  publish-pypi:
    name: Publish to PyPI
    needs: [prepare-matrix, build-wheels, test-wheels]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.publish_to_pypi == 'true' ||
        github.event.inputs.publish_to_test_pypi == 'true'))

    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/
          pattern: wheels-*
          merge-multiple: true

      - name: List wheels for PyPI
        run: |
          echo "=========================================="
          echo "Wheels ready for PyPI publishing:"
          echo "=========================================="
          ls -lh dist/*.whl || echo "No wheels found"
          echo ""
          echo "Total wheels: $(ls dist/*.whl 2>/dev/null | wc -l)"

      - name: Validate secrets
        run: |
          # Check that required secrets are present (without exposing values)
          if [ "${{ github.event.inputs.publish_to_test_pypi }}" == "true" ]; then
            if [ -z "${{ secrets.TEST_PYPI_API_TOKEN }}" ]; then
              echo "Error: TEST_PYPI_API_TOKEN secret is not set"
              exit 1
            fi
            echo "TEST_PYPI_API_TOKEN is configured"
          fi

          if [ "${{ github.event.inputs.publish_to_pypi }}" == "true" ]; then
            if [ -z "${{ secrets.PYPI_API_TOKEN }}" ]; then
              echo "Error: PYPI_API_TOKEN secret is not set"
              exit 1
            fi
            echo "PYPI_API_TOKEN is configured"
          fi

      - name: Publish to Test PyPI
        if: |
          github.event.inputs.publish_to_test_pypi == 'true' ||
          (github.event_name == 'push' && contains(github.ref, 'alpha')) ||
          (github.event_name == 'push' && contains(github.ref, 'beta'))
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository-url: https://test.pypi.org/legacy/
          skip-existing: true
          print-hash: true
          verbose: true

      - name: Publish to PyPI
        if: |
          github.event.inputs.publish_to_pypi == 'true' ||
          (github.event_name == 'push' &&
           startsWith(github.ref, 'refs/tags/v') &&
           !contains(github.ref, 'alpha') &&
           !contains(github.ref, 'beta') &&
           !contains(github.ref, 'rc'))
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          print-hash: true
          verbose: true

  # Summary job
  build-summary:
    name: Build Summary
    needs: [prepare-matrix, build-wheels, test-wheels, github-release, publish-pypi]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    steps:
      - name: Check build status
        run: |
          echo "=========================================="
          echo "Build Summary"
          echo "=========================================="
          echo "vLLM Version: ${{ needs.prepare-matrix.outputs.vllm_version }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo ""
          echo "Build Status: ${{ needs.build-wheels.result }}"
          echo "Test Status: ${{ needs.test-wheels.result }}"
          echo "GitHub Release: ${{ needs.github-release.result }}"
          echo "PyPI Publish: ${{ needs.publish-pypi.result }}"
          echo "=========================================="

          # Fail if any required builds failed
          if [ "${{ needs.build-wheels.result }}" != "success" ] || [ "${{ needs.test-wheels.result }}" != "success" ]; then
            echo "‚ùå Build or tests failed!"
            exit 1
          else
            echo "‚úÖ All builds and tests passed!"

            # Optional jobs status
            if [ "${{ needs.github-release.result }}" == "success" ]; then
              echo "‚úÖ GitHub Release created successfully"
            fi

            if [ "${{ needs.publish-pypi.result }}" == "success" ]; then
              echo "‚úÖ Published to PyPI successfully"
            fi
          fi
