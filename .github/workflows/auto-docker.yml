name: Auto-Build Docker Images

# Automatically checks for new vLLM releases and builds Docker images
# - Builds for both AMD64 and ARM64
# - All 5 variants: noavx512, avx512, avx512vnni, avx512bf16, amxbf16
# - Pushes to Docker Hub (primary) and GHCR (secondary)
# - Tags: version-specific and 'latest' for newest version

on:
  # Run once a day at 00:00 UTC (temporary - will change back to every 30 minutes)
  schedule:
    - cron: '0 12 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      force_version:
        description: 'Force build specific version (optional, e.g., 0.12.0)'
        required: false
        type: string
      dry_run:
        description: 'Dry run - check versions only, no build'
        required: false
        type: boolean
        default: false

env:
  DOCKERHUB_IMAGE: mekayelanik/vllm-cpu
  GHCR_IMAGE: ghcr.io/${{ github.repository }}

jobs:
  # Check for new vLLM versions that need Docker images
  check-versions:
    name: Check for New Versions
    runs-on: ubuntu-latest
    outputs:
      new_versions: ${{ steps.compare.outputs.new_versions }}
      has_new_versions: ${{ steps.compare.outputs.has_new_versions }}
      latest_version: ${{ steps.compare.outputs.latest_version }}
      needs_latest_update: ${{ steps.check_latest.outputs.needs_update }}

    steps:
      - name: Fetch vLLM releases from GitHub
        id: github
        run: |
          echo "Fetching vLLM releases from GitHub..."

          # Fetch all releases >= 0.8.4 (no older versions needed)
          GITHUB_VERSIONS=$(curl -s "https://api.github.com/repos/vllm-project/vllm/releases?per_page=100" | \
            jq -r '.[].tag_name' | \
            grep -E '^v[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?$' | \
            sed 's/^v//' | \
            sort -V | \
            awk -F. '$1 > 0 || ($1 == 0 && ($2 > 8 || ($2 == 8 && $3 >= 4)))')

          echo "GitHub versions (stable only, >= 0.8.4):"
          echo "$GITHUB_VERSIONS"

          # Save to file for later use
          echo "$GITHUB_VERSIONS" > /tmp/github_versions.txt

      - name: Get latest version from PyPI
        id: pypi_latest
        run: |
          echo "Fetching latest version from PyPI..."

          # Get the latest version from PyPI (what users can pip install)
          PYPI_LATEST=$(curl -s "https://pypi.org/pypi/vllm-cpu/json" | \
            jq -r '.info.version' | \
            grep -oE '^[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?' || echo "")

          if [ -n "$PYPI_LATEST" ]; then
            echo "Latest version on PyPI: $PYPI_LATEST"
          else
            # Fallback to latest from GitHub if PyPI fails
            PYPI_LATEST=$(cat /tmp/github_versions.txt | tail -1)
            echo "PyPI fetch failed, using GitHub latest: $PYPI_LATEST"
          fi

          echo "$PYPI_LATEST" > /tmp/latest_version.txt

      - name: Check existing Docker Hub images
        id: dockerhub
        run: |
          echo "Checking existing Docker Hub images..."

          # Get list of existing tags from Docker Hub
          EXISTING_VERSIONS=""

          # Fetch existing tags from Docker Hub API
          DOCKERHUB_TAGS=$(curl -s "https://hub.docker.com/v2/repositories/${{ env.DOCKERHUB_IMAGE }}/tags?page_size=100" 2>/dev/null | \
            jq -r '.results[].name' 2>/dev/null || echo "")

          if [ -n "$DOCKERHUB_TAGS" ]; then
            # Extract version numbers from tags
            # Tags can be: <version>-<variant> (0.11.2-noavx512) or <variant>-<version> (noavx512-0.11.2)
            # Extract any version pattern X.Y.Z or X.Y.Z.W from anywhere in the tag
            EXISTING_VERSIONS=$(echo "$DOCKERHUB_TAGS" | \
              grep -oE '[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?' | \
              sort -V -u)
            echo "Existing Docker Hub image versions:"
            echo "$EXISTING_VERSIONS"
          else
            echo "No existing Docker Hub images found or unable to fetch"
          fi

          # Save to file
          echo "$EXISTING_VERSIONS" > /tmp/docker_versions.txt

      - name: Compare versions
        id: compare
        run: |
          echo "Comparing versions..."

          # Handle force version input
          if [[ -n "${{ github.event.inputs.force_version }}" ]]; then
            echo "Force building version: ${{ github.event.inputs.force_version }}"
            NEW_VERSIONS="${{ github.event.inputs.force_version }}"
            echo "new_versions=[\"$NEW_VERSIONS\"]" >> "$GITHUB_OUTPUT"
            echo "has_new_versions=true" >> "$GITHUB_OUTPUT"
            echo "latest_version=$(cat /tmp/latest_version.txt)" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Find versions in GitHub but not in Docker registry
          NEW_VERSIONS=""
          while IFS= read -r version; do
            if [[ -n "$version" ]] && ! grep -qx "$version" /tmp/docker_versions.txt; then
              echo "New version found: $version"
              if [[ -n "$NEW_VERSIONS" ]]; then
                NEW_VERSIONS="$NEW_VERSIONS,$version"
              else
                NEW_VERSIONS="$version"
              fi
            fi
          done < /tmp/github_versions.txt

          LATEST_VERSION=$(cat /tmp/latest_version.txt)

          if [[ -z "$NEW_VERSIONS" ]]; then
            echo "No new versions found"
            echo "new_versions=[]" >> "$GITHUB_OUTPUT"
            echo "has_new_versions=false" >> "$GITHUB_OUTPUT"
          else
            echo "New versions to build: $NEW_VERSIONS"
            # Convert comma-separated to JSON array
            JSON_ARRAY=$(echo "$NEW_VERSIONS" | tr ',' '\n' | jq -R . | jq -s -c .)
            echo "new_versions=$JSON_ARRAY" >> "$GITHUB_OUTPUT"
            echo "has_new_versions=true" >> "$GITHUB_OUTPUT"
          fi

          echo "latest_version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"

      - name: Check if latest tags need updating
        id: check_latest
        run: |
          LATEST_VERSION=$(cat /tmp/latest_version.txt)
          echo "Checking if latest tags point to $LATEST_VERSION..."

          # Check if noavx512-latest exists and what version it points to
          # We check by looking for the latest version in existing tags
          CURRENT_LATEST=""
          if [ -f /tmp/docker_versions.txt ]; then
            CURRENT_LATEST=$(cat /tmp/docker_versions.txt | sort -V | tail -1)
          fi

          echo "Current latest in Docker Hub: $CURRENT_LATEST"
          echo "PyPI latest: $LATEST_VERSION"

          if [ "$CURRENT_LATEST" != "$LATEST_VERSION" ]; then
            echo "Latest tags need updating!"
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
          else
            echo "Latest tags are up to date"
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Summary
        run: |
          echo "=========================================="
          echo "Docker Image Version Check Summary"
          echo "=========================================="
          echo "New versions: ${{ steps.compare.outputs.new_versions }}"
          echo "Has new versions: ${{ steps.compare.outputs.has_new_versions }}"
          echo "Latest version: ${{ steps.compare.outputs.latest_version }}"
          echo "Needs latest update: ${{ steps.check_latest.outputs.needs_update }}"
          echo "=========================================="

  # Build Docker images for each variant and platform
  build-images:
    name: Build ${{ matrix.variant }} (${{ matrix.version }})
    needs: check-versions
    if: needs.check-versions.outputs.has_new_versions == 'true' && github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJson(needs.check-versions.outputs.new_versions) }}
        variant: [noavx512, avx512, avx512vnni, avx512bf16, amxbf16]

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKERHUB_IMAGE }}
            ${{ env.GHCR_IMAGE }}
          tags: |
            # Version-variant tag: 0.11.2-noavx512
            type=raw,value=${{ matrix.version }}-${{ matrix.variant }}
            # Variant-version tag: noavx512-0.11.2
            type=raw,value=${{ matrix.variant }}-${{ matrix.version }}
            # NOTE: <variant>-latest tags are handled by update-latest-tags job

      - name: Determine platforms
        id: platforms
        run: |
          # noavx512 supports both AMD64 and ARM64
          # Other variants are x86_64 only
          if [[ "${{ matrix.variant }}" == "noavx512" ]]; then
            echo "platforms=linux/amd64,linux/arm64" >> "$GITHUB_OUTPUT"
          else
            echo "platforms=linux/amd64" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./docker
          file: ./docker/Dockerfile
          platforms: ${{ steps.platforms.outputs.platforms }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VLLM_VERSION=${{ matrix.version }}
            VARIANT=${{ matrix.variant }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify image
        run: |
          echo "Verifying image for ${{ matrix.variant }} @ ${{ matrix.version }}..."
          docker pull ${{ env.DOCKERHUB_IMAGE }}:${{ matrix.version }}-${{ matrix.variant }}
          docker run --rm ${{ env.DOCKERHUB_IMAGE }}:${{ matrix.version }}-${{ matrix.variant }} \
            python -c "import vllm; print(f'vLLM version: {vllm.__version__}')"

  # Update <variant>-latest tags by re-tagging existing images (no rebuild needed)
  update-latest-tags:
    name: Update ${{ matrix.variant }}-latest tag
    needs: [check-versions, build-images]
    if: |
      always() &&
      github.event.inputs.dry_run != 'true' &&
      needs.check-versions.outputs.needs_latest_update == 'true' &&
      (needs.build-images.result == 'success' || needs.build-images.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        variant: [noavx512, avx512, avx512vnni, avx512bf16, amxbf16]

    permissions:
      contents: read
      packages: write

    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Re-tag image as latest (Docker Hub & GHCR)
        run: |
          LATEST_VERSION="${{ needs.check-versions.outputs.latest_version }}"
          VARIANT="${{ matrix.variant }}"

          SOURCE_TAG="${VARIANT}-${LATEST_VERSION}"
          LATEST_TAG="${VARIANT}-latest"

          echo "Attempting to re-tag ${SOURCE_TAG} as ${LATEST_TAG}..."

          # Try to pull the version-specific image from Docker Hub
          if docker pull ${{ env.DOCKERHUB_IMAGE }}:${SOURCE_TAG} 2>/dev/null; then
            echo "Found image on Docker Hub, re-tagging..."

            # Tag and push to Docker Hub
            docker tag ${{ env.DOCKERHUB_IMAGE }}:${SOURCE_TAG} \
                       ${{ env.DOCKERHUB_IMAGE }}:${LATEST_TAG}
            docker push ${{ env.DOCKERHUB_IMAGE }}:${LATEST_TAG}
            echo "Successfully updated Docker Hub ${LATEST_TAG} -> ${LATEST_VERSION}"

            # Tag and push to GHCR
            docker tag ${{ env.DOCKERHUB_IMAGE }}:${SOURCE_TAG} \
                       ${{ env.GHCR_IMAGE }}:${LATEST_TAG}
            docker push ${{ env.GHCR_IMAGE }}:${LATEST_TAG}
            echo "Successfully updated GHCR ${LATEST_TAG} -> ${LATEST_VERSION}"
          else
            echo "WARNING: Image ${SOURCE_TAG} not found on Docker Hub"
            echo "This can happen if PyPI has a version we haven't built yet"
            echo "Skipping latest tag update for ${VARIANT}"
            exit 0
          fi

      - name: Verify latest image
        run: |
          LATEST_VERSION="${{ needs.check-versions.outputs.latest_version }}"
          VARIANT="${{ matrix.variant }}"

          # Only verify if the image exists
          if docker pull ${{ env.DOCKERHUB_IMAGE }}:${VARIANT}-latest 2>/dev/null; then
            echo "Verifying ${VARIANT}-latest..."
            docker run --rm ${{ env.DOCKERHUB_IMAGE }}:${VARIANT}-latest \
              python -c "import vllm; print(f'vLLM version: {vllm.__version__}')"
          else
            echo "No ${VARIANT}-latest image to verify (expected if source image didn't exist)"
          fi

  # Summary
  summary:
    name: Build Summary
    needs: [check-versions, build-images, update-latest-tags]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Summary
        run: |
          echo "=========================================="
          echo "Auto Docker Build Summary"
          echo "=========================================="
          echo ""
          echo "New versions found: ${{ needs.check-versions.outputs.new_versions }}"
          echo "Latest version (PyPI): ${{ needs.check-versions.outputs.latest_version }}"
          echo "Needs latest update: ${{ needs.check-versions.outputs.needs_latest_update }}"
          echo ""
          echo "Build Results:"
          echo "  New images: ${{ needs.build-images.result }}"
          echo "  Latest tags: ${{ needs.update-latest-tags.result }}"
          echo "=========================================="

          if [[ "${{ needs.check-versions.outputs.has_new_versions }}" != "true" ]] && \
             [[ "${{ needs.check-versions.outputs.needs_latest_update }}" != "true" ]]; then
            echo "No updates needed - all Docker images up to date!"
          else
            if [[ "${{ needs.build-images.result }}" == "success" ]]; then
              echo "Successfully built new version images!"
            fi
            if [[ "${{ needs.update-latest-tags.result }}" == "success" ]]; then
              echo "Successfully updated latest tags!"
            fi
            echo ""
            echo "Docker Hub (primary):"
            echo "  docker pull ${{ env.DOCKERHUB_IMAGE }}:noavx512-latest"
            echo ""
            echo "GHCR (secondary):"
            echo "  docker pull ${{ env.GHCR_IMAGE }}:noavx512-latest"
          fi
