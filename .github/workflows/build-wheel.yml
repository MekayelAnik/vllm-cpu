# =============================================================================
# Auto-Build vLLM CPU Wheels
# =============================================================================
# Automatically checks for new vLLM releases and builds wheels for them
# - noavx512 (vllm-cpu): Built for both AMD64 and ARM64
# - avx512, avx512vnni, avx512bf16, amxbf16: Built for AMD64 only
#
# Security Best Practices Applied:
# - Minimal permissions per job (principle of least privilege)
# - Concurrency control to prevent duplicate runs
# - Timeout limits to prevent runaway jobs
# - Action pinning with SHA hashes for supply chain security
#
# Architecture:
# - Uses _check-versions.yml to generate unified build matrix
# - Uses _build-wheel-job.yml for parallel builds via matrix strategy
# - Uses _publish-pypi.yml and _update-release-notes.yml for releases
# =============================================================================

name: Auto-Build vLLM CPU Wheels

on:
  # Run every hour to check for new vLLM releases
  # Note: Actual builds only run when new versions are detected
  schedule:
    - cron: '0 * * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      vllm_versions:
        description: 'vLLM versions (e.g., 0.12.0 or 0.11.2,0.12.0 or 0.11.0-0.12.0) - leave empty for auto-detect'
        required: false
        type: string
        default: ''
      python_versions:
        description: 'Python versions (optional, e.g., 3.12 or 3.10-3.13) - leave empty for auto-detect'
        required: false
        type: string
        default: 'auto'
      build_noavx512:
        description: 'Build noavx512 (universal, AMD64+ARM64)'
        required: false
        type: boolean
        default: true
      build_avx512:
        description: 'Build avx512 (AMD64 only)'
        required: false
        type: boolean
        default: true
      build_avx512vnni:
        description: 'Build avx512vnni (AMD64 only)'
        required: false
        type: boolean
        default: true
      build_avx512bf16:
        description: 'Build avx512bf16 (AMD64 only)'
        required: false
        type: boolean
        default: true
      build_amxbf16:
        description: 'Build amxbf16 (AMD64 only)'
        required: false
        type: boolean
        default: true
      platforms:
        description: 'Target platforms'
        required: false
        type: choice
        options:
          - 'all'
          - 'linux/amd64'
          - 'linux/arm64'
        default: 'all'
      skip_pypi:
        description: 'Skip PyPI publishing'
        required: false
        type: boolean
        default: false
      skip_github_release:
        description: 'Skip GitHub release creation'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run - check versions only, no build'
        required: false
        type: boolean
        default: false
      version_postfix:
        description: 'Version postfix (e.g., .post1, .dev2, .rc1) - leave empty for standard release'
        required: false
        type: string
        default: ''

# Concurrency control:
# - Scheduled runs: Only one at a time, queue others (don't cancel running)
# - Manual runs: No concurrency limits - multiple can run in parallel
# Using run_id ensures each manual trigger gets its own unique group
concurrency:
  group: ${{ github.event_name == 'schedule' && 'wheel-scheduled' || format('wheel-manual-{0}', github.run_id) }}
  cancel-in-progress: false

# Default permissions: Read-only (principle of least privilege)
# Individual jobs override as needed
permissions:
  contents: read

env:
  # Use consistent UV version across all jobs
  UV_VERSION: "0.5"

jobs:
  # ==========================================================================
  # Check for new vLLM versions and generate unified build matrix
  # ==========================================================================
  check-versions:
    name: Check Versions
    uses: ./.github/workflows/_check-versions.yml
    with:
      vllm_versions: ${{ inputs.vllm_versions || '' }}
      build_noavx512: ${{ inputs.build_noavx512 == '' && true || inputs.build_noavx512 }}
      build_avx512: ${{ inputs.build_avx512 == '' && true || inputs.build_avx512 }}
      build_avx512vnni: ${{ inputs.build_avx512vnni == '' && true || inputs.build_avx512vnni }}
      build_avx512bf16: ${{ inputs.build_avx512bf16 == '' && true || inputs.build_avx512bf16 }}
      build_amxbf16: ${{ inputs.build_amxbf16 == '' && true || inputs.build_amxbf16 }}
      platforms: ${{ inputs.platforms || 'all' }}
      version_postfix: ${{ inputs.version_postfix || '' }}
    secrets: inherit

  # ==========================================================================
  # Unified build job with dynamic matrix
  # ==========================================================================
  build:
    name: Build ${{ matrix.variant }} ${{ matrix.platform }} (${{ matrix.version }})
    needs: check-versions
    # CRITICAL: Skip if no builds (empty matrix causes "Matrix vector does not contain any values" error)
    if: |
      needs.check-versions.outputs.has_builds == 'true' &&
      (inputs.dry_run == '' || inputs.dry_run == false)
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.check-versions.outputs.build_matrix) }}
    uses: ./.github/workflows/_build-wheel-job.yml
    with:
      variant: ${{ matrix.variant }}
      platform: ${{ matrix.platform }}
      version: ${{ matrix.version }}
      python_versions: ${{ inputs.python_versions || 'auto' }}
      version_postfix: ${{ needs.check-versions.outputs.version_postfix }}
      skip_github_release: ${{ inputs.skip_github_release == '' && false || inputs.skip_github_release }}
      uv_version: "0.5"
    secrets: inherit

  # ==========================================================================
  # Publish all wheels to PyPI
  # ==========================================================================
  publish:
    name: Publish to PyPI (${{ matrix.version }})
    needs: [check-versions, build]
    if: |
      always() &&
      needs.check-versions.outputs.has_builds == 'true' &&
      needs.build.result == 'success' &&
      (inputs.dry_run == '' || inputs.dry_run == false) &&
      (inputs.skip_pypi == '' || inputs.skip_pypi == false)
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJSON(needs.check-versions.outputs.new_versions) }}
    uses: ./.github/workflows/_publish-pypi.yml
    with:
      version: ${{ matrix.version }}
      version_postfix: ${{ needs.check-versions.outputs.version_postfix }}
    secrets: inherit

  # ==========================================================================
  # Update GitHub Release Notes
  # ==========================================================================
  github-release:
    name: Update Release Notes (${{ matrix.version }})
    needs: [check-versions, build, publish]
    if: |
      always() &&
      needs.check-versions.outputs.has_builds == 'true' &&
      needs.build.result == 'success' &&
      (inputs.dry_run == '' || inputs.dry_run == false) &&
      (inputs.skip_github_release == '' || inputs.skip_github_release == false)
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJSON(needs.check-versions.outputs.new_versions) }}
    uses: ./.github/workflows/_update-release-notes.yml
    with:
      version: ${{ matrix.version }}
      version_postfix: ${{ needs.check-versions.outputs.version_postfix }}
    secrets: inherit

  # ==========================================================================
  # Summary
  # ==========================================================================
  summary:
    name: Build Summary
    needs: [check-versions, build, publish, github-release]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Generate Summary
        run: |
          echo "## Auto-Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version Check" >> $GITHUB_STEP_SUMMARY
          echo "- **Versions:** ${{ needs.check-versions.outputs.new_versions }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version postfix:** ${{ needs.check-versions.outputs.version_postfix || '(none)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Has builds:** ${{ needs.check-versions.outputs.has_builds }}" >> $GITHUB_STEP_SUMMARY
          echo "- **AMD64:** ${{ needs.check-versions.outputs.build_amd64 }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ARM64:** ${{ needs.check-versions.outputs.build_arm64 }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Matrix" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo '${{ needs.check-versions.outputs.build_matrix }}' | jq . >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo '${{ needs.check-versions.outputs.build_matrix }}' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PyPI Publish | ${{ needs.publish.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.github-release.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check Overall Status
        run: |
          if [[ "${{ needs.check-versions.outputs.has_builds }}" != "true" ]]; then
            echo "No new versions to build - all up to date!"
          elif [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "Successfully built wheels!"
            if [[ "${{ needs.publish.result }}" == "success" ]]; then
              echo "Successfully published to PyPI!"
            fi
          else
            echo "::warning::Some jobs failed - check logs for details"
          fi
