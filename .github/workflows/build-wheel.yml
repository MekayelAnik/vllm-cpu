# =============================================================================
# Auto-Build vLLM CPU Wheels
# =============================================================================
# Automatically checks for new vLLM releases and builds wheels for them
# - noavx512 (vllm-cpu): Built for both AMD64 and ARM64
# - avx512, avx512vnni, avx512bf16, amxbf16: Built for AMD64 only
#
# Security Best Practices Applied:
# - Minimal permissions per job (principle of least privilege)
# - Concurrency control to prevent duplicate runs
# - Timeout limits to prevent runaway jobs
# - Action pinning with SHA hashes for supply chain security
# =============================================================================

name: Auto-Build vLLM CPU Wheels

on:
  # Run every hour to check for new vLLM releases
  # Note: Actual builds only run when new versions are detected
  schedule:
    - cron: '0 * * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      vllm_versions:
        description: 'vLLM versions (e.g., 0.12.0 or 0.11.2,0.12.0 or 0.11.0-0.12.0) - leave empty for auto-detect'
        required: false
        type: string
        default: ''
      python_versions:
        description: 'Python versions (optional, e.g., 3.12 or 3.10-3.13) - leave empty for auto-detect'
        required: false
        type: string
        default: 'auto'
      build_noavx512:
        description: 'Build noavx512 (universal, AMD64+ARM64)'
        required: false
        type: boolean
        default: true
      build_avx512:
        description: 'Build avx512 (AMD64 only)'
        required: false
        type: boolean
        default: true
      build_avx512vnni:
        description: 'Build avx512vnni (AMD64 only)'
        required: false
        type: boolean
        default: true
      build_avx512bf16:
        description: 'Build avx512bf16 (AMD64 only)'
        required: false
        type: boolean
        default: true
      build_amxbf16:
        description: 'Build amxbf16 (AMD64 only)'
        required: false
        type: boolean
        default: true
      platforms:
        description: 'Target platforms'
        required: false
        type: choice
        options:
          - 'all'
          - 'linux/amd64'
          - 'linux/arm64'
        default: 'all'
      skip_pypi:
        description: 'Skip PyPI publishing'
        required: false
        type: boolean
        default: false
      skip_github_release:
        description: 'Skip GitHub release creation'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run - check versions only, no build'
        required: false
        type: boolean
        default: false
      version_postfix:
        description: 'Version postfix (e.g., .post1, .dev2, .rc1) - leave empty for standard release'
        required: false
        type: string
        default: ''

# Concurrency control:
# - Scheduled runs: Only one at a time, queue others (don't cancel running)
# - Manual runs: Each gets unique group (run_id), so multiple can run in parallel
concurrency:
  group: ${{ github.event_name == 'schedule' && format('{0}-scheduled', github.workflow) || format('{0}-manual-{1}', github.workflow, github.run_id) }}
  cancel-in-progress: false

# Default permissions: Read-only (principle of least privilege)
# Individual jobs override as needed
permissions:
  contents: read

env:
  # Use consistent UV version across all jobs
  UV_VERSION: "0.5"

jobs:
  # ==========================================================================
  # Check for new vLLM versions
  # ==========================================================================
  check-versions:
    name: Check for New Versions
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      new_versions: ${{ steps.compare.outputs.new_versions }}
      has_new_versions: ${{ steps.compare.outputs.has_new_versions }}
      selected_variant: ${{ steps.variants.outputs.selected }}
      build_noavx512: ${{ steps.variants.outputs.build_noavx512 }}
      build_avx512_variants: ${{ steps.variants.outputs.build_avx512_variants }}
      avx512_matrix: ${{ steps.variants.outputs.avx512_matrix }}
      build_amd64: ${{ steps.platforms.outputs.build_amd64 }}
      build_arm64: ${{ steps.platforms.outputs.build_arm64 }}
      version_postfix: ${{ steps.postfix.outputs.postfix }}

    steps:
      - name: Validate version postfix
        id: postfix
        run: |
          POSTFIX="${{ github.event.inputs.version_postfix }}"

          if [[ -z "$POSTFIX" ]]; then
            echo "No version postfix specified"
            echo "postfix=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Normalize postfix: add leading dot if missing
          # Accepts: post1, .post1, dev2, .dev2, rc1, .rc1, a1, .a1, b1, .b1
          if [[ "$POSTFIX" =~ ^\.?(post|dev|a|b|rc)([0-9]+)$ ]]; then
            TYPE="${BASH_REMATCH[1]}"
            NUM="${BASH_REMATCH[2]}"
            NORMALIZED=".${TYPE}${NUM}"
            echo "Input postfix: $POSTFIX -> Normalized: $NORMALIZED"
            echo "postfix=$NORMALIZED" >> "$GITHUB_OUTPUT"
          else
            echo "::error::Invalid version postfix '$POSTFIX'. Must match pattern: post1, .post1, dev2, .dev2, rc1, a1, b1, etc."
            exit 1
          fi

      - name: Fetch vLLM releases from GitHub
        id: github
        run: |
          echo "Fetching vLLM releases from GitHub..."

          # Use GitHub token for higher rate limits (5000/hour vs 60/hour)
          # Fetch all releases >= 0.8.5 (no older versions needed)
          GITHUB_VERSIONS=$(curl -sfL --retry 3 --retry-delay 5 \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/vllm-project/vllm/releases?per_page=100" | \
            jq -r '.[].tag_name' | \
            grep -E '^v[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?$' | \
            sed 's/^v//' | \
            sort -V | \
            awk -F. '$1 > 0 || ($1 == 0 && ($2 > 8 || ($2 == 8 && $3 >= 5)))')

          if [[ -z "$GITHUB_VERSIONS" ]]; then
            echo "::error::Failed to fetch vLLM releases from GitHub (possible rate limit)"
            exit 1
          fi

          echo "GitHub versions (stable only):"
          echo "$GITHUB_VERSIONS"

          # Save to file for later use
          echo "$GITHUB_VERSIONS" > /tmp/github_versions.txt

      - name: Fetch existing versions from PyPI
        id: pypi
        run: |
          echo "Fetching existing versions from PyPI..."

          # Query PyPI for vllm-cpu package versions with retry
          # PyPI has generous rate limits, no auth needed
          PYPI_VERSIONS=$(curl -sfL --retry 3 --retry-delay 5 \
            "https://pypi.org/pypi/vllm-cpu/json" | \
            jq -r '.releases | keys[]' | \
            grep -E '^[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?$' | \
            sort -V)

          if [[ -z "$PYPI_VERSIONS" ]]; then
            echo "::warning::Failed to fetch PyPI versions, assuming no existing versions"
            touch /tmp/pypi_versions.txt
          else
            echo "PyPI versions (excluding .post/.dev):"
            echo "$PYPI_VERSIONS"
            echo "$PYPI_VERSIONS" > /tmp/pypi_versions.txt
          fi

      - name: Compare versions
        id: compare
        run: |
          echo "Comparing versions..."

          # Handle vllm_versions input (supports: single, comma-separated, or range)
          INPUT_VERSIONS="${{ github.event.inputs.vllm_versions }}"
          if [[ -n "$INPUT_VERSIONS" ]]; then
            echo "Manual version input: $INPUT_VERSIONS"

            # Parse the input - could be single, comma-separated, or range
            PARSED_VERSIONS=""

            # Check if it's a range (e.g., "0.11.0-0.12.0")
            if [[ "$INPUT_VERSIONS" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
              START_VER="${BASH_REMATCH[1]}"
              END_VER="${BASH_REMATCH[2]}"
              echo "Parsing version range: $START_VER to $END_VER"

              # Get all versions from GitHub that fall within the range
              while IFS= read -r ver; do
                if [[ -n "$ver" ]]; then
                  # Compare versions using sort -V
                  if [[ $(echo -e "$START_VER\n$ver" | sort -V | head -1) == "$START_VER" ]] && \
                     [[ $(echo -e "$ver\n$END_VER" | sort -V | head -1) == "$ver" ]]; then
                    if [[ -n "$PARSED_VERSIONS" ]]; then
                      PARSED_VERSIONS="$PARSED_VERSIONS,$ver"
                    else
                      PARSED_VERSIONS="$ver"
                    fi
                  fi
                fi
              done < /tmp/github_versions.txt

              if [[ -z "$PARSED_VERSIONS" ]]; then
                echo "No versions found in range $START_VER to $END_VER"
                echo "new_versions=[]" >> "$GITHUB_OUTPUT"
                echo "has_new_versions=false" >> "$GITHUB_OUTPUT"
                exit 0
              fi
              echo "Versions in range: $PARSED_VERSIONS"
            else
              # Single version or comma-separated list - validate against available versions
              PARSED_VERSIONS=""
              SKIPPED_VERSIONS=""
              IFS=',' read -ra INPUT_ARRAY <<< "$INPUT_VERSIONS"
              for ver in "${INPUT_ARRAY[@]}"; do
                ver=$(echo "$ver" | tr -d ' ')  # Trim whitespace
                if grep -qx "$ver" /tmp/github_versions.txt; then
                  if [[ -n "$PARSED_VERSIONS" ]]; then
                    PARSED_VERSIONS="$PARSED_VERSIONS,$ver"
                  else
                    PARSED_VERSIONS="$ver"
                  fi
                else
                  echo "::warning::vLLM version $ver not found in GitHub releases - skipping"
                  if [[ -n "$SKIPPED_VERSIONS" ]]; then
                    SKIPPED_VERSIONS="$SKIPPED_VERSIONS,$ver"
                  else
                    SKIPPED_VERSIONS="$ver"
                  fi
                fi
              done

              if [[ -n "$SKIPPED_VERSIONS" ]]; then
                echo "Skipped unavailable versions: $SKIPPED_VERSIONS"
              fi

              if [[ -z "$PARSED_VERSIONS" ]]; then
                echo "::error::No valid vLLM versions found. Requested: $INPUT_VERSIONS"
                echo "new_versions=[]" >> "$GITHUB_OUTPUT"
                echo "has_new_versions=false" >> "$GITHUB_OUTPUT"
                exit 0
              fi
            fi

            # Convert to JSON array
            JSON_ARRAY=$(echo "$PARSED_VERSIONS" | tr ',' '\n' | jq -R . | jq -s -c .)
            echo "Valid versions to build: $PARSED_VERSIONS"
            echo "new_versions=$JSON_ARRAY" >> "$GITHUB_OUTPUT"
            echo "has_new_versions=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Auto-detect: Find versions in GitHub but not in PyPI
          NEW_VERSIONS=""
          while IFS= read -r version; do
            if [[ -n "$version" ]] && ! grep -qx "$version" /tmp/pypi_versions.txt; then
              echo "New version found: $version"
              if [[ -n "$NEW_VERSIONS" ]]; then
                NEW_VERSIONS="$NEW_VERSIONS,$version"
              else
                NEW_VERSIONS="$version"
              fi
            fi
          done < /tmp/github_versions.txt

          if [[ -z "$NEW_VERSIONS" ]]; then
            echo "No new versions found"
            echo "new_versions=[]" >> "$GITHUB_OUTPUT"
            echo "has_new_versions=false" >> "$GITHUB_OUTPUT"
          else
            echo "New versions to build: $NEW_VERSIONS"
            # Convert comma-separated to JSON array
            JSON_ARRAY=$(echo "$NEW_VERSIONS" | tr ',' '\n' | jq -R . | jq -s -c .)
            echo "new_versions=$JSON_ARRAY" >> "$GITHUB_OUTPUT"
            echo "has_new_versions=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Determine variants to build
        id: variants
        run: |
          # Build from individual checkbox inputs
          # For scheduled runs, default to all variants (true)
          BUILD_NOAVX512="${{ github.event.inputs.build_noavx512 || 'true' }}"
          BUILD_AVX512="${{ github.event.inputs.build_avx512 || 'true' }}"
          BUILD_AVX512VNNI="${{ github.event.inputs.build_avx512vnni || 'true' }}"
          BUILD_AVX512BF16="${{ github.event.inputs.build_avx512bf16 || 'true' }}"
          BUILD_AMXBF16="${{ github.event.inputs.build_amxbf16 || 'true' }}"

          echo "Variant selection:"
          echo "  noavx512: $BUILD_NOAVX512"
          echo "  avx512: $BUILD_AVX512"
          echo "  avx512vnni: $BUILD_AVX512VNNI"
          echo "  avx512bf16: $BUILD_AVX512BF16"
          echo "  amxbf16: $BUILD_AMXBF16"

          # Set noavx512 build flag
          echo "build_noavx512=$BUILD_NOAVX512" >> "$GITHUB_OUTPUT"

          # Build AVX512 variants matrix from selected checkboxes
          AVX512_VARIANTS=""
          if [[ "$BUILD_AVX512" == "true" ]]; then
            AVX512_VARIANTS="${AVX512_VARIANTS:+$AVX512_VARIANTS,}avx512"
          fi
          if [[ "$BUILD_AVX512VNNI" == "true" ]]; then
            AVX512_VARIANTS="${AVX512_VARIANTS:+$AVX512_VARIANTS,}avx512vnni"
          fi
          if [[ "$BUILD_AVX512BF16" == "true" ]]; then
            AVX512_VARIANTS="${AVX512_VARIANTS:+$AVX512_VARIANTS,}avx512bf16"
          fi
          if [[ "$BUILD_AMXBF16" == "true" ]]; then
            AVX512_VARIANTS="${AVX512_VARIANTS:+$AVX512_VARIANTS,}amxbf16"
          fi

          if [[ -z "$AVX512_VARIANTS" ]]; then
            echo "build_avx512_variants=false" >> "$GITHUB_OUTPUT"
            echo 'avx512_matrix=[]' >> "$GITHUB_OUTPUT"
          else
            echo "build_avx512_variants=true" >> "$GITHUB_OUTPUT"
            MATRIX=$(echo "$AVX512_VARIANTS" | tr ',' '\n' | jq -R . | jq -s -c .)
            echo "avx512_matrix=$MATRIX" >> "$GITHUB_OUTPUT"
          fi

          # Generate selected summary for display
          SELECTED=""
          [[ "$BUILD_NOAVX512" == "true" ]] && SELECTED="${SELECTED:+$SELECTED,}noavx512"
          [[ -n "$AVX512_VARIANTS" ]] && SELECTED="${SELECTED:+$SELECTED,}$AVX512_VARIANTS"
          echo "selected=${SELECTED:-none}" >> "$GITHUB_OUTPUT"

      - name: Determine platforms to build
        id: platforms
        run: |
          SELECTED_PLATFORM="${{ github.event.inputs.platforms || 'all' }}"
          echo "Selected platform: $SELECTED_PLATFORM"

          if [[ "$SELECTED_PLATFORM" == "all" || "$SELECTED_PLATFORM" == "linux/amd64" ]]; then
            echo "build_amd64=true" >> "$GITHUB_OUTPUT"
          else
            echo "build_amd64=false" >> "$GITHUB_OUTPUT"
          fi

          if [[ "$SELECTED_PLATFORM" == "all" || "$SELECTED_PLATFORM" == "linux/arm64" ]]; then
            echo "build_arm64=true" >> "$GITHUB_OUTPUT"
          else
            echo "build_arm64=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate platform-variant compatibility
        run: |
          SELECTED_VARIANT="${{ steps.variants.outputs.selected }}"
          BUILD_AMD64="${{ steps.platforms.outputs.build_amd64 }}"
          BUILD_ARM64="${{ steps.platforms.outputs.build_arm64 }}"
          BUILD_NOAVX512="${{ steps.variants.outputs.build_noavx512 }}"
          BUILD_AVX512="${{ steps.variants.outputs.build_avx512_variants }}"

          # Check for incompatible combinations
          # AVX512 variants require AMD64
          if [[ "$BUILD_AVX512" == "true" && "$BUILD_AMD64" != "true" ]]; then
            echo "::warning::AVX512 variants ($SELECTED_VARIANT) require linux/amd64 platform. Selected platform does not include AMD64 - AVX512 builds will be skipped."
          fi

          # ARM64 only supports noavx512
          if [[ "$BUILD_ARM64" == "true" && "$BUILD_AMD64" != "true" && "$BUILD_NOAVX512" != "true" ]]; then
            echo "::error::ARM64 platform only supports noavx512 variant, but '$SELECTED_VARIANT' was selected. No builds will run."
          fi

          # Check if any builds will actually run
          WILL_BUILD=false
          if [[ "$BUILD_NOAVX512" == "true" && ("$BUILD_AMD64" == "true" || "$BUILD_ARM64" == "true") ]]; then
            WILL_BUILD=true
          fi
          if [[ "$BUILD_AVX512" == "true" && "$BUILD_AMD64" == "true" ]]; then
            WILL_BUILD=true
          fi

          if [[ "$WILL_BUILD" != "true" && "${{ steps.compare.outputs.has_new_versions }}" == "true" ]]; then
            echo "::error::No builds will run with the selected variant ($SELECTED_VARIANT) and platform combination."
          fi

      - name: Summary
        run: |
          echo "=========================================="
          echo "Version Check Summary"
          echo "=========================================="
          echo "New versions: ${{ steps.compare.outputs.new_versions }}"
          echo "Has new versions: ${{ steps.compare.outputs.has_new_versions }}"
          echo "Version postfix: ${{ steps.postfix.outputs.postfix || '(none)' }}"
          echo "Selected variant: ${{ steps.variants.outputs.selected }}"
          echo "Build noavx512: ${{ steps.variants.outputs.build_noavx512 }}"
          echo "Build AVX512 variants: ${{ steps.variants.outputs.build_avx512_variants }}"
          echo "AVX512 matrix: ${{ steps.variants.outputs.avx512_matrix }}"
          echo "Build AMD64: ${{ steps.platforms.outputs.build_amd64 }}"
          echo "Build ARM64: ${{ steps.platforms.outputs.build_arm64 }}"
          echo "=========================================="

  # ==========================================================================
  # Build noavx512 (vllm-cpu) for AMD64
  # ==========================================================================
  build-noavx512-amd64:
    name: Build noavx512 AMD64 (${{ matrix.version }})
    needs: check-versions
    if: |
      needs.check-versions.outputs.has_new_versions == 'true' &&
      needs.check-versions.outputs.build_noavx512 == 'true' &&
      needs.check-versions.outputs.build_amd64 == 'true' &&
      (github.event.inputs.dry_run || 'false') != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 240
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJson(needs.check-versions.outputs.new_versions) }}

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup environment
        run: |
          # Ensure all shell scripts are executable
          find . -name "*.sh" -type f -exec chmod +x {} \;
          # Create required directories
          mkdir -p dist
          mkdir -p ~/.cache/ccache

      - name: Free disk space
        run: |
          # Remove unnecessary large packages to free disk space
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            python3 python3-pip python3-venv \
            build-essential gcc g++ \
            cmake ninja-build ccache \
            libnuma-dev numactl jq

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          version: ${{ env.UV_VERSION }}
          # Disable uv's built-in cache to avoid "cache path does not exist" errors
          # when builds don't use uv extensively. We rely on ccache for build caching.
          enable-cache: false

      - name: Cache ccache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/ccache
          key: ccache-amd64-noavx512-${{ matrix.version }}-${{ github.sha }}
          restore-keys: |
            ccache-amd64-noavx512-${{ matrix.version }}-
            ccache-amd64-noavx512-
            ccache-amd64-

      - name: Build wheels
        run: |
          echo "Building noavx512 for AMD64, vLLM ${{ matrix.version }}"
          POSTFIX="${{ needs.check-versions.outputs.version_postfix }}"
          ./build_wheels.sh \
            --variant=noavx512 \
            --vllm-versions="${{ matrix.version }}" \
            --python-versions="${{ github.event.inputs.python_versions || 'auto' }}" \
            ${POSTFIX:+--version-suffix="$POSTFIX"} \
            --output-dir=dist

      - name: List built wheels
        run: |
          echo "=== Built wheels ==="
          find dist -name "*.whl" -exec ls -lh {} \;

      - name: Upload artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: wheels-noavx512-amd64-${{ matrix.version }}${{ needs.check-versions.outputs.version_postfix }}
          path: dist/**/*.whl
          retention-days: 30
          if-no-files-found: error

  # ==========================================================================
  # Build noavx512 (vllm-cpu) for ARM64
  # ==========================================================================
  build-noavx512-arm64:
    name: Build noavx512 ARM64 (${{ matrix.version }})
    needs: check-versions
    if: |
      needs.check-versions.outputs.has_new_versions == 'true' &&
      needs.check-versions.outputs.build_noavx512 == 'true' &&
      needs.check-versions.outputs.build_arm64 == 'true' &&
      (github.event.inputs.dry_run || 'false') != 'true'
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 300
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJson(needs.check-versions.outputs.new_versions) }}

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup environment
        run: |
          # Ensure all shell scripts are executable
          find . -name "*.sh" -type f -exec chmod +x {} \;
          # Create required directories
          mkdir -p dist
          mkdir -p ~/.cache/ccache

      - name: Free disk space
        run: |
          # Remove unnecessary large packages to free disk space
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc 2>/dev/null || true
          df -h

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            python3 python3-pip python3-venv \
            build-essential gcc g++ \
            cmake ninja-build ccache \
            libnuma-dev numactl jq

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          version: ${{ env.UV_VERSION }}
          # Disable uv's built-in cache to avoid "cache path does not exist" errors
          # when builds don't use uv extensively. We rely on ccache for build caching.
          enable-cache: false

      - name: Cache ccache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/ccache
          key: ccache-arm64-noavx512-${{ matrix.version }}-${{ github.sha }}
          restore-keys: |
            ccache-arm64-noavx512-${{ matrix.version }}-
            ccache-arm64-noavx512-
            ccache-arm64-

      - name: Build wheels
        run: |
          echo "Building noavx512 for ARM64, vLLM ${{ matrix.version }}"
          POSTFIX="${{ needs.check-versions.outputs.version_postfix }}"
          ./build_wheels.sh \
            --variant=noavx512 \
            --vllm-versions="${{ matrix.version }}" \
            --python-versions="${{ github.event.inputs.python_versions || 'auto' }}" \
            ${POSTFIX:+--version-suffix="$POSTFIX"} \
            --output-dir=dist

      - name: List built wheels
        run: |
          echo "=== Built wheels ==="
          find dist -name "*.whl" -exec ls -lh {} \;

      - name: Upload artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: wheels-noavx512-arm64-${{ matrix.version }}${{ needs.check-versions.outputs.version_postfix }}
          path: dist/**/*.whl
          retention-days: 30
          if-no-files-found: error

  # ==========================================================================
  # Build AVX512 variants for AMD64 only
  # ==========================================================================
  build-avx512-variants:
    name: Build ${{ matrix.variant }} AMD64 (${{ matrix.version }})
    needs: check-versions
    if: |
      needs.check-versions.outputs.has_new_versions == 'true' &&
      needs.check-versions.outputs.build_avx512_variants == 'true' &&
      needs.check-versions.outputs.build_amd64 == 'true' &&
      (github.event.inputs.dry_run || 'false') != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 240
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJson(needs.check-versions.outputs.new_versions) }}
        variant: ${{ fromJson(needs.check-versions.outputs.avx512_matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup environment
        run: |
          # Ensure all shell scripts are executable
          find . -name "*.sh" -type f -exec chmod +x {} \;
          # Create required directories
          mkdir -p dist
          mkdir -p ~/.cache/ccache

      - name: Free disk space
        run: |
          # Remove unnecessary large packages to free disk space
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          df -h

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            python3 python3-pip python3-venv \
            build-essential gcc g++ \
            cmake ninja-build ccache \
            libnuma-dev numactl jq

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          version: ${{ env.UV_VERSION }}
          # Disable uv's built-in cache to avoid "cache path does not exist" errors
          # when builds don't use uv extensively. We rely on ccache for build caching.
          enable-cache: false

      - name: Cache ccache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/ccache
          key: ccache-amd64-${{ matrix.variant }}-${{ matrix.version }}-${{ github.sha }}
          restore-keys: |
            ccache-amd64-${{ matrix.variant }}-${{ matrix.version }}-
            ccache-amd64-${{ matrix.variant }}-
            ccache-amd64-

      - name: Build wheels
        run: |
          echo "Building ${{ matrix.variant }} for AMD64, vLLM ${{ matrix.version }}"
          POSTFIX="${{ needs.check-versions.outputs.version_postfix }}"
          ./build_wheels.sh \
            --variant=${{ matrix.variant }} \
            --vllm-versions="${{ matrix.version }}" \
            --python-versions="${{ github.event.inputs.python_versions || 'auto' }}" \
            ${POSTFIX:+--version-suffix="$POSTFIX"} \
            --output-dir=dist

      - name: List built wheels
        run: |
          echo "=== Built wheels ==="
          find dist -name "*.whl" -exec ls -lh {} \;

      - name: Upload artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: wheels-${{ matrix.variant }}-amd64-${{ matrix.version }}${{ needs.check-versions.outputs.version_postfix }}
          path: dist/**/*.whl
          retention-days: 30
          if-no-files-found: error

  # ==========================================================================
  # Publish all wheels to PyPI
  # ==========================================================================
  publish:
    name: Publish to PyPI (${{ matrix.version }})
    needs: [check-versions, build-noavx512-amd64, build-noavx512-arm64, build-avx512-variants]
    if: |
      always() &&
      needs.check-versions.outputs.has_new_versions == 'true' &&
      (github.event.inputs.dry_run || 'false') != 'true' &&
      (github.event.inputs.skip_pypi || 'false') != 'true' &&
      (needs.build-noavx512-amd64.result == 'success' ||
       needs.build-noavx512-arm64.result == 'success' ||
       needs.build-avx512-variants.result == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJson(needs.check-versions.outputs.new_versions) }}

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup environment
        run: |
          # Ensure all shell scripts are executable
          find . -name "*.sh" -type f -exec chmod +x {} \;
          # Create required directories
          mkdir -p dist

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends python3 python3-pip jq
          pip3 install --user twine

      - name: Download all wheels for version ${{ matrix.version }}
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: dist/
          pattern: wheels-*-${{ matrix.version }}${{ needs.check-versions.outputs.version_postfix }}
          merge-multiple: true

      - name: List all wheels
        run: |
          echo "=========================================="
          echo "Wheels to publish for v${{ matrix.version }}${{ needs.check-versions.outputs.version_postfix }}:"
          echo "=========================================="
          find dist -name "*.whl" -exec ls -lh {} \;
          echo ""
          echo "Total: $(find dist -name '*.whl' 2>/dev/null | wc -l) wheels"

      - name: Publish wheels
        run: |
          # Detect Python versions from existing wheels
          WHEEL_PY_VERSIONS=$(find dist -name "*.whl" -type f | sed -n 's/.*-cp\([0-9]*\)-cp.*/\1/p' | sort -u | while read v; do echo "3.${v#3}"; done | tr '\n' ',' | sed 's/,$//')
          echo "Detected Python versions: $WHEEL_PY_VERSIONS"

          # Detect which variants actually have wheels (only publish what exists)
          AVAILABLE_VARIANTS=""
          for variant in noavx512 avx512 avx512vnni avx512bf16 amxbf16; do
            # Map variant name to wheel pattern
            if [[ "$variant" == "noavx512" ]]; then
              pattern="vllm_cpu-"
            else
              pattern="vllm_cpu_${variant}-"
            fi
            if find dist -name "${pattern}*.whl" 2>/dev/null | grep -q .; then
              if [[ -n "$AVAILABLE_VARIANTS" ]]; then
                AVAILABLE_VARIANTS="$AVAILABLE_VARIANTS,$variant"
              else
                AVAILABLE_VARIANTS="$variant"
              fi
            fi
          done

          if [[ -z "$AVAILABLE_VARIANTS" ]]; then
            echo "::error::No wheels found to publish!"
            exit 1
          fi

          echo "Variants with wheels: $AVAILABLE_VARIANTS"

          # Publish each variant separately to handle partial builds
          IFS=',' read -ra VARIANTS <<< "$AVAILABLE_VARIANTS"
          FAILED=0
          for variant in "${VARIANTS[@]}"; do
            echo "Publishing variant: $variant"
            if ! ./build_and_verify.sh \
              --skip-build \
              --skip-github \
              --variant="$variant" \
              --vllm-versions="${{ matrix.version }}" \
              --python-versions="${WHEEL_PY_VERSIONS:-auto}" \
              --platform=all \
              --dist-dir=dist; then
              echo "::warning::Failed to publish $variant"
              FAILED=$((FAILED + 1))
            fi
          done

          if [[ $FAILED -gt 0 ]]; then
            echo "::warning::$FAILED variant(s) failed to publish"
          fi
        env:
          PYPI_TOKEN_CPU: ${{ secrets.PYPI_TOKEN_CPU }}
          PYPI_TOKEN_AVX512: ${{ secrets.PYPI_TOKEN_AVX512 }}
          PYPI_TOKEN_AVX512VNNI: ${{ secrets.PYPI_TOKEN_AVX512VNNI }}
          PYPI_TOKEN_AVX512BF16: ${{ secrets.PYPI_TOKEN_AVX512BF16 }}
          PYPI_TOKEN_AMXBF16: ${{ secrets.PYPI_TOKEN_AMXBF16 }}
          PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

  # ==========================================================================
  # Create GitHub Release
  # ==========================================================================
  github-release:
    name: GitHub Release (${{ matrix.version }})
    needs: [check-versions, build-noavx512-amd64, build-noavx512-arm64, build-avx512-variants, publish]
    if: |
      always() &&
      needs.check-versions.outputs.has_new_versions == 'true' &&
      (github.event.inputs.dry_run || 'false') != 'true' &&
      (github.event.inputs.skip_github_release || 'false') != 'true' &&
      (needs.build-noavx512-amd64.result == 'success' ||
       needs.build-noavx512-arm64.result == 'success' ||
       needs.build-avx512-variants.result == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write  # Required for creating releases
    strategy:
      fail-fast: false
      matrix:
        version: ${{ fromJson(needs.check-versions.outputs.new_versions) }}

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup environment
        run: |
          # Create required directories
          mkdir -p dist

      - name: Download all wheels for version ${{ matrix.version }}
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: dist/
          pattern: wheels-*-${{ matrix.version }}${{ needs.check-versions.outputs.version_postfix }}
          merge-multiple: true

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ matrix.version }}"
          POSTFIX="${{ needs.check-versions.outputs.version_postfix }}"
          FULL_VERSION="${VERSION}${POSTFIX}"
          TAG="v${FULL_VERSION}"
          BASE_URL="https://github.com/MekayelAnik/vllm-cpu/releases/download/${TAG}"

          # Find actual wheel filenames from dist/
          echo "=== Available wheels ==="
          find dist -name "*.whl" -type f | sort

          # Generate release notes with actual wheel filenames
          cat > release_notes.md << EOF
          ## vLLM CPU Wheels v${FULL_VERSION}

          Automatically built from upstream vLLM release.

          ### Quick Install from GitHub Release

          EOF

          # Find the first vllm_cpu wheel for Python 3.12 x86_64 for the quick install example
          EXAMPLE_WHEEL=$(find dist -name "vllm_cpu-*-cp312-*x86_64*.whl" -type f | head -1 | xargs basename 2>/dev/null || echo "")
          if [[ -n "$EXAMPLE_WHEEL" ]]; then
            echo '```bash' >> release_notes.md
            echo "pip install \"vllm-cpu @ ${BASE_URL}/${EXAMPLE_WHEEL}\" --index-url https://download.pytorch.org/whl/cpu --extra-index-url https://pypi.org/simple" >> release_notes.md
            echo '```' >> release_notes.md
          fi

          echo "" >> release_notes.md
          echo "### All Variants" >> release_notes.md
          echo "" >> release_notes.md
          echo "| Package | Target CPUs | Install Command (Python 3.12 x86_64) |" >> release_notes.md
          echo "|---------|-------------|--------------------------------------|" >> release_notes.md

          # Generate table rows for each variant
          declare -A VARIANT_MAP=(
            ["vllm_cpu"]="vllm-cpu|All CPUs (x86_64, ARM64)"
            ["vllm_cpu_avx512"]="vllm-cpu-avx512|Skylake-X+"
            ["vllm_cpu_avx512vnni"]="vllm-cpu-avx512vnni|Cascade Lake+"
            ["vllm_cpu_avx512bf16"]="vllm-cpu-avx512bf16|Cooper Lake+"
            ["vllm_cpu_amxbf16"]="vllm-cpu-amxbf16|Sapphire Rapids+"
          )

          for wheel_prefix in vllm_cpu vllm_cpu_avx512 vllm_cpu_avx512vnni vllm_cpu_avx512bf16 vllm_cpu_amxbf16; do
            # Find wheel for Python 3.12 x86_64
            WHEEL=$(find dist -name "${wheel_prefix}-*-cp312-*x86_64*.whl" -type f 2>/dev/null | head -1 | xargs basename 2>/dev/null || echo "")
            if [[ -n "$WHEEL" ]]; then
              PKG_NAME=$(echo "${VARIANT_MAP[$wheel_prefix]}" | cut -d'|' -f1)
              TARGET_CPUS=$(echo "${VARIANT_MAP[$wheel_prefix]}" | cut -d'|' -f2)
              echo "| \`${PKG_NAME}\` | ${TARGET_CPUS} | \`pip install \"${PKG_NAME} @ ${BASE_URL}/${WHEEL}\" --index-url https://download.pytorch.org/whl/cpu --extra-index-url https://pypi.org/simple\` |" >> release_notes.md
            fi
          done

          echo "" >> release_notes.md
          echo "> **Note:** Replace \`cp312\` with \`cp310\`, \`cp311\`, or \`cp313\` for other Python versions. Replace \`x86_64\` with \`aarch64\` for ARM64 (only \`vllm-cpu\` supports ARM64)." >> release_notes.md

          # Debug output
          echo "=== Generated release notes ==="
          cat release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          tag_name: v${{ matrix.version }}${{ needs.check-versions.outputs.version_postfix }}
          name: vLLM CPU v${{ matrix.version }}${{ needs.check-versions.outputs.version_postfix }}
          files: dist/**/*.whl
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(needs.check-versions.outputs.version_postfix, 'dev') || contains(needs.check-versions.outputs.version_postfix, 'rc') || contains(needs.check-versions.outputs.version_postfix, 'a') || contains(needs.check-versions.outputs.version_postfix, 'b') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # Summary
  # ==========================================================================
  summary:
    name: Build Summary
    needs: [check-versions, build-noavx512-amd64, build-noavx512-arm64, build-avx512-variants, publish, github-release]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Generate Summary
        run: |
          echo "## Auto-Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version Check" >> $GITHUB_STEP_SUMMARY
          echo "- **New versions found:** ${{ needs.check-versions.outputs.new_versions }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Has new versions:** ${{ needs.check-versions.outputs.has_new_versions }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version postfix:** ${{ needs.check-versions.outputs.version_postfix || '(none)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| noavx512 AMD64 | ${{ needs.build-noavx512-amd64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| noavx512 ARM64 | ${{ needs.build-noavx512-arm64.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AVX512 variants | ${{ needs.build-avx512-variants.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PyPI Publish | ${{ needs.publish.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.github-release.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check Overall Status
        run: |
          if [[ "${{ needs.check-versions.outputs.has_new_versions }}" != "true" ]]; then
            echo "No new versions to build - all up to date!"
          elif [[ "${{ needs.publish.result }}" == "success" ]]; then
            echo "Successfully built and published new versions!"
          else
            echo "::warning::Some jobs failed - check logs for details"
          fi
