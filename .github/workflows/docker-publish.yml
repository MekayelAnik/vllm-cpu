name: Build and Publish Docker Images

on:
  workflow_dispatch:
    inputs:
      vllm_version:
        description: 'vLLM version (optional, e.g., 0.12.0) - leave empty for latest from PyPI'
        required: false
        type: string
        default: ''
      python_version:
        description: 'Python version (optional, e.g., 3.12) - leave empty for auto-detect'
        required: false
        type: string
        default: ''
      variants:
        description: 'Variants to build'
        required: false
        type: choice
        options:
          - 'all'
          - 'noavx512'
          - 'avx512'
          - 'avx512vnni'
          - 'avx512bf16'
          - 'amxbf16'
        default: 'all'
      platforms:
        description: 'Target platforms'
        required: false
        type: choice
        options:
          - 'all'
          - 'linux/amd64'
          - 'linux/arm64'
        default: 'all'
      use_github_release:
        description: 'Use GitHub release wheels instead of PyPI'
        required: false
        type: boolean
        default: false
      push:
        description: 'Push images to registries'
        required: false
        type: boolean
        default: true
      skip_dockerhub:
        description: 'Skip Docker Hub publishing'
        required: false
        type: boolean
        default: false
      skip_ghcr:
        description: 'Skip GitHub Container Registry publishing'
        required: false
        type: boolean
        default: false
      skip_latest_tag:
        description: 'Skip updating latest tags (only create version-specific tags)'
        required: false
        type: boolean
        default: false
      build_profile:
        description: 'Build profile'
        required: false
        type: choice
        options:
          - 'production'
          - 'ci'
          - 'development'
        default: 'production'
      dry_run:
        description: 'Dry run - build locally without pushing'
        required: false
        type: boolean
        default: false

  # Also trigger on release creation
  release:
    types: [published]

env:
  DOCKERHUB_REPO: mekayelanik/vllm-cpu
  GHCR_REPO: ghcr.io/${{ github.repository_owner }}/vllm-cpu

jobs:
  # Prepare build matrix
  prepare:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.result }}
      vllm_version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine vLLM version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            # Extract version from release tag (remove 'v' prefix)
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
          elif [ -n "${{ github.event.inputs.vllm_version }}" ]; then
            VERSION="${{ github.event.inputs.vllm_version }}"
          else
            # Auto-detect latest version from PyPI
            echo "No version specified, fetching latest from PyPI..."
            VERSION=$(curl -sfL "https://pypi.org/pypi/vllm-cpu/json" | jq -r '.info.version')
            if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
              echo "::error::Failed to fetch latest version from PyPI"
              exit 1
            fi
            echo "Auto-detected latest version: ${VERSION}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Building version: ${VERSION}"

      - name: Generate build matrix
        id: matrix
        uses: actions/github-script@v7
        with:
          script: |
            // Define variants with their supported platforms
            // noavx512 supports both amd64 and arm64 (multi-arch manifest)
            // All other variants are x86_64 only (Intel-specific instruction sets)
            const variants = [
              { name: 'noavx512', package: 'vllm-cpu', tag: 'noavx512', platforms: ['linux/amd64', 'linux/arm64'] },
              { name: 'avx512', package: 'vllm-cpu-avx512', tag: 'avx512', platforms: ['linux/amd64'] },
              { name: 'avx512vnni', package: 'vllm-cpu-avx512vnni', tag: 'avx512vnni', platforms: ['linux/amd64'] },
              { name: 'avx512bf16', package: 'vllm-cpu-avx512bf16', tag: 'avx512bf16', platforms: ['linux/amd64'] },
              { name: 'amxbf16', package: 'vllm-cpu-amxbf16', tag: 'amxbf16', platforms: ['linux/amd64'] }
            ];

            // Determine which variants to build
            let inputVariants = '${{ github.event.inputs.variants || 'all' }}';
            let selectedVariants = variants;

            if (inputVariants !== 'all') {
              const requestedNames = inputVariants.split(',').map(v => v.trim());
              selectedVariants = variants.filter(v => requestedNames.includes(v.name));
            }

            // Determine requested platforms
            let inputPlatforms = '${{ github.event.inputs.platforms || 'all' }}';
            let requestedPlatforms = inputPlatforms === 'all'
              ? ['linux/amd64', 'linux/arm64']
              : [inputPlatforms];

            // Build matrix - each variant gets all its supported platforms that were requested
            // This ensures multi-arch manifests are created (e.g., noavx512 with both amd64+arm64)
            const matrix = [];
            for (const variant of selectedVariants) {
              // Filter to platforms that are both supported by variant AND requested by user
              const platforms = variant.platforms.filter(p => requestedPlatforms.includes(p));
              if (platforms.length > 0) {
                matrix.push({
                  variant: variant.name,
                  package: variant.package,
                  tag: variant.tag,
                  // Join all platforms - buildx will create a multi-arch manifest
                  platforms: platforms.join(',')
                });
              }
            }

            console.log('Build matrix:', JSON.stringify(matrix, null, 2));
            return matrix;

  # Build and push Docker images
  # Each variant builds all its supported platforms in a single job
  # This creates proper multi-arch manifest images
  build:
    name: Build ${{ matrix.variant }}
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64,amd64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:latest
            env.BUILDKIT_STEP_LOG_MAX_SIZE=50000000
            env.BUILDKIT_STEP_LOG_MAX_SPEED=100000000
            env.BUILDKIT_INLINE_CACHE=1
            env.BUILDKIT_CACHE_MOUNT_NS=buildkit
          buildkitd-config-inline: |
            [worker.oci]
              max-parallelism = 4
            [registry."docker.io"]
              mirrors = ["mirror.gcr.io"]

      - name: Login to Docker Hub
        if: (github.event.inputs.push || 'true') != 'false' && (github.event.inputs.skip_dockerhub || 'false') != 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        if: (github.event.inputs.push || 'true') != 'false' && (github.event.inputs.skip_ghcr || 'false') != 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure build profile
        id: profile
        run: |
          PROFILE="${{ github.event.inputs.build_profile || 'production' }}"
          echo "Using build profile: ${PROFILE}"

          case "${PROFILE}" in
            "production")
              # Maximum compression for smallest image size (zstd level 22)
              echo "compression_type=zstd" >> "$GITHUB_OUTPUT"
              echo "compression_level=22" >> "$GITHUB_OUTPUT"
              echo "profile_desc=Maximum compression (zstd-22), smallest images" >> "$GITHUB_OUTPUT"
              ;;
            "size-optimized")
              # Even more aggressive compression (slower builds, smallest possible images)
              echo "compression_type=zstd" >> "$GITHUB_OUTPUT"
              echo "compression_level=22" >> "$GITHUB_OUTPUT"
              echo "profile_desc=Size optimized (zstd-22 + estargz)" >> "$GITHUB_OUTPUT"
              ;;
            "ci")
              # Balanced speed and compression for CI
              echo "compression_type=zstd" >> "$GITHUB_OUTPUT"
              echo "compression_level=10" >> "$GITHUB_OUTPUT"
              echo "profile_desc=Balanced (zstd-10)" >> "$GITHUB_OUTPUT"
              ;;
            "development")
              # Fast builds with minimal compression
              echo "compression_type=gzip" >> "$GITHUB_OUTPUT"
              echo "compression_level=1" >> "$GITHUB_OUTPUT"
              echo "profile_desc=Fast builds (gzip-1)" >> "$GITHUB_OUTPUT"
              ;;
            *)
              # Default to production profile
              echo "compression_type=zstd" >> "$GITHUB_OUTPUT"
              echo "compression_level=22" >> "$GITHUB_OUTPUT"
              echo "profile_desc=Default (zstd-22)" >> "$GITHUB_OUTPUT"
              ;;
          esac

      - name: Build and push multi-arch image
        env:
          VLLM_VERSION: ${{ needs.prepare.outputs.vllm_version }}
          VARIANT: ${{ matrix.variant }}
          PLATFORMS: ${{ matrix.platforms }}
          USE_GITHUB_RELEASE: ${{ github.event.inputs.use_github_release || 'false' }}
          PYTHON_VERSION: ${{ github.event.inputs.python_version || '' }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          # For release triggers, inputs are null, so default to 'true' for push
          PUSH_IMAGE: ${{ (github.event.inputs.dry_run == 'true' && 'false') || (github.event.inputs.push || 'true') != 'false' }}
          SKIP_DOCKERHUB: ${{ github.event.inputs.skip_dockerhub || 'false' }}
          SKIP_GHCR: ${{ github.event.inputs.skip_ghcr || 'false' }}
          SKIP_LATEST_TAG: ${{ github.event.inputs.skip_latest_tag || 'false' }}
          COMPRESSION_TYPE: ${{ steps.profile.outputs.compression_type }}
          COMPRESSION_LEVEL: ${{ steps.profile.outputs.compression_level }}
        run: |
          echo "=========================================="
          echo "Building vLLM CPU Docker Image"
          echo "=========================================="
          echo "Version: ${VLLM_VERSION}"
          echo "Python: ${PYTHON_VERSION:-auto-detect}"
          echo "Variant: ${VARIANT}"
          echo "Platforms: ${PLATFORMS}"
          echo "Use GitHub Release: ${USE_GITHUB_RELEASE}"
          echo "Compression: ${COMPRESSION_TYPE} level ${COMPRESSION_LEVEL}"
          echo "Push: ${PUSH_IMAGE}"
          echo "Dry Run: ${DRY_RUN}"
          echo "Skip Docker Hub: ${SKIP_DOCKERHUB}"
          echo "Skip GHCR: ${SKIP_GHCR}"
          echo "Skip Latest Tag: ${SKIP_LATEST_TAG}"
          echo "=========================================="

          # Build tags based on which registries are enabled
          TAGS=""

          # Docker Hub tags
          if [[ "${SKIP_DOCKERHUB}" != "true" ]]; then
            VERSION_TAG="${{ env.DOCKERHUB_REPO }}:${{ matrix.tag }}-${VLLM_VERSION}"
            TAGS="${TAGS} --tag ${VERSION_TAG}"
            echo "Docker Hub version tag: ${VERSION_TAG}"

            if [[ "${SKIP_LATEST_TAG}" != "true" ]]; then
              LATEST_TAG="${{ env.DOCKERHUB_REPO }}:${{ matrix.tag }}-latest"
              TAGS="${TAGS} --tag ${LATEST_TAG}"
              echo "Docker Hub latest tag: ${LATEST_TAG}"
            fi
          fi

          # GHCR tags
          if [[ "${SKIP_GHCR}" != "true" ]]; then
            GHCR_VERSION_TAG="${{ env.GHCR_REPO }}:${{ matrix.tag }}-${VLLM_VERSION}"
            TAGS="${TAGS} --tag ${GHCR_VERSION_TAG}"
            echo "GHCR version tag: ${GHCR_VERSION_TAG}"

            if [[ "${SKIP_LATEST_TAG}" != "true" ]]; then
              GHCR_LATEST_TAG="${{ env.GHCR_REPO }}:${{ matrix.tag }}-latest"
              TAGS="${TAGS} --tag ${GHCR_LATEST_TAG}"
              echo "GHCR latest tag: ${GHCR_LATEST_TAG}"
            fi
          fi

          # Ensure at least one registry is enabled
          if [[ -z "${TAGS}" ]]; then
            echo "::error::Both Docker Hub and GHCR are skipped. At least one registry must be enabled."
            exit 1
          fi

          # Determine output type based on push setting
          if [[ "${PUSH_IMAGE}" == "true" ]]; then
            OUTPUT_TYPE="type=registry"
          else
            OUTPUT_TYPE="type=image"
          fi

          # Build compression parameters
          COMPRESSION_PARAMS="compression=${COMPRESSION_TYPE},compression-level=${COMPRESSION_LEVEL},force-compression=true"
          if [[ "${COMPRESSION_TYPE}" == "zstd" ]]; then
            # Use all available CPU threads for zstd compression
            COMPRESSION_PARAMS="${COMPRESSION_PARAMS},compression-threads=0"
          fi

          # Cache configuration - use Docker Hub for cache if available, otherwise GHCR
          if [[ "${SKIP_DOCKERHUB}" != "true" ]]; then
            CACHE_REPO="${{ env.DOCKERHUB_REPO }}"
          else
            CACHE_REPO="${{ env.GHCR_REPO }}"
          fi

          # Execute docker buildx build
          # --pull ensures we always get latest base image
          # --progress=plain provides detailed logs for CI
          # Add Python version arg if specified
          PYTHON_ARG=""
          if [[ -n "${PYTHON_VERSION}" ]]; then
            PYTHON_ARG="--build-arg PYTHON_VERSION=${PYTHON_VERSION}"
          fi

          docker buildx build \
            --file ./docker/Dockerfile \
            --platform "${PLATFORMS}" \
            --pull \
            --progress=plain \
            --build-arg VLLM_VERSION="${VLLM_VERSION}" \
            --build-arg VARIANT="${VARIANT}" \
            --build-arg USE_GITHUB_RELEASE="${USE_GITHUB_RELEASE}" \
            ${PYTHON_ARG} \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            --build-arg BUILDKIT_MULTI_PLATFORM=1 \
            --label "org.opencontainers.image.title=vLLM CPU (${VARIANT})" \
            --label "org.opencontainers.image.description=vLLM CPU inference engine - ${VARIANT} variant" \
            --label "org.opencontainers.image.version=${VLLM_VERSION}" \
            --label "org.opencontainers.image.source=https://github.com/${{ github.repository }}" \
            --label "vllm.variant=${VARIANT}" \
            --cache-from "type=registry,ref=${CACHE_REPO}:buildcache-${VARIANT}" \
            --cache-to "type=registry,ref=${CACHE_REPO}:buildcache-${VARIANT},mode=max" \
            --output "${OUTPUT_TYPE},oci-mediatypes=true,${COMPRESSION_PARAMS}" \
            ${TAGS} \
            --provenance=false \
            --sbom=false \
            ./docker

          echo "=========================================="
          echo "Build completed successfully!"
          echo "=========================================="

      - name: Test amd64 image
        if: (github.event.inputs.push || 'true') != 'false' && contains(matrix.platforms, 'linux/amd64')
        env:
          SKIP_DOCKERHUB: ${{ github.event.inputs.skip_dockerhub || 'false' }}
        run: |
          # Use Docker Hub if available, otherwise GHCR
          if [[ "${SKIP_DOCKERHUB}" != "true" ]]; then
            IMAGE="${{ env.DOCKERHUB_REPO }}:${{ matrix.tag }}-${{ needs.prepare.outputs.vllm_version }}"
          else
            IMAGE="${{ env.GHCR_REPO }}:${{ matrix.tag }}-${{ needs.prepare.outputs.vllm_version }}"
          fi
          echo "Testing amd64 image: ${IMAGE}"
          docker run --rm --platform linux/amd64 "${IMAGE}" \
            python -c "import vllm; print(f'vLLM {vllm.__version__} loaded successfully on amd64')"
          echo "amd64 test passed!"

      - name: Test arm64 image
        if: (github.event.inputs.push || 'true') != 'false' && contains(matrix.platforms, 'linux/arm64')
        env:
          SKIP_DOCKERHUB: ${{ github.event.inputs.skip_dockerhub || 'false' }}
        run: |
          # Use Docker Hub if available, otherwise GHCR
          if [[ "${SKIP_DOCKERHUB}" != "true" ]]; then
            IMAGE="${{ env.DOCKERHUB_REPO }}:${{ matrix.tag }}-${{ needs.prepare.outputs.vllm_version }}"
          else
            IMAGE="${{ env.GHCR_REPO }}:${{ matrix.tag }}-${{ needs.prepare.outputs.vllm_version }}"
          fi
          echo "Testing arm64 image: ${IMAGE}"
          docker run --rm --platform linux/arm64 "${IMAGE}" \
            python -c "import vllm; print(f'vLLM {vllm.__version__} loaded successfully on arm64')"
          echo "arm64 test passed!"

  # Summary job
  summary:
    name: Build Summary
    needs: [prepare, build]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Summary
        env:
          SKIP_LATEST: ${{ github.event.inputs.skip_latest_tag || 'false' }}
        run: |
          echo "# Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **vLLM Version:** ${{ needs.prepare.outputs.vllm_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Variants:** ${{ github.event.inputs.variants || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms:** ${{ github.event.inputs.platforms || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Profile:** ${{ github.event.inputs.build_profile || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Compression:** zstd level 22 (production) / zstd level 10 (ci) / gzip level 1 (development)" >> $GITHUB_STEP_SUMMARY
          echo "- **Push:** ${{ github.event.inputs.push || 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip Latest Tags:** ${SKIP_LATEST}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Images Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Hub" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKERHUB_REPO }}:<variant>-${{ needs.prepare.outputs.vllm_version }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${SKIP_LATEST}" != "true" ]]; then
            echo "docker pull ${{ env.DOCKERHUB_REPO }}:<variant>-latest" >> $GITHUB_STEP_SUMMARY
          fi
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GitHub Container Registry" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.GHCR_REPO }}:<variant>-${{ needs.prepare.outputs.vllm_version }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${SKIP_LATEST}" != "true" ]]; then
            echo "docker pull ${{ env.GHCR_REPO }}:<variant>-latest" >> $GITHUB_STEP_SUMMARY
          fi
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Available Tags (Multi-Arch Manifests)" >> $GITHUB_STEP_SUMMARY
          if [[ "${SKIP_LATEST}" != "true" ]]; then
            echo "| Variant | Version Tag | Latest Tag | Platforms |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-------------|------------|-----------|" >> $GITHUB_STEP_SUMMARY
            echo "| noavx512 | noavx512-${{ needs.prepare.outputs.vllm_version }} | noavx512-latest | amd64, arm64 |" >> $GITHUB_STEP_SUMMARY
            echo "| avx512 | avx512-${{ needs.prepare.outputs.vllm_version }} | avx512-latest | amd64 |" >> $GITHUB_STEP_SUMMARY
            echo "| avx512vnni | avx512vnni-${{ needs.prepare.outputs.vllm_version }} | avx512vnni-latest | amd64 |" >> $GITHUB_STEP_SUMMARY
            echo "| avx512bf16 | avx512bf16-${{ needs.prepare.outputs.vllm_version }} | avx512bf16-latest | amd64 |" >> $GITHUB_STEP_SUMMARY
            echo "| amxbf16 | amxbf16-${{ needs.prepare.outputs.vllm_version }} | amxbf16-latest | amd64 |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Variant | Version Tag | Platforms |" >> $GITHUB_STEP_SUMMARY
            echo "|---------|-------------|-----------|" >> $GITHUB_STEP_SUMMARY
            echo "| noavx512 | noavx512-${{ needs.prepare.outputs.vllm_version }} | amd64, arm64 |" >> $GITHUB_STEP_SUMMARY
            echo "| avx512 | avx512-${{ needs.prepare.outputs.vllm_version }} | amd64 |" >> $GITHUB_STEP_SUMMARY
            echo "| avx512vnni | avx512vnni-${{ needs.prepare.outputs.vllm_version }} | amd64 |" >> $GITHUB_STEP_SUMMARY
            echo "| avx512bf16 | avx512bf16-${{ needs.prepare.outputs.vllm_version }} | amd64 |" >> $GITHUB_STEP_SUMMARY
            echo "| amxbf16 | amxbf16-${{ needs.prepare.outputs.vllm_version }} | amd64 |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> **Note:** Latest tags were skipped for this build." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** The noavx512 variant is a multi-arch manifest containing both amd64 and arm64 images under the same tag." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Usage" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Run vLLM with a model" >> $GITHUB_STEP_SUMMARY
          echo "docker run -p 8000:8000 -v \$HOME/.cache/huggingface:/models \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.DOCKERHUB_REPO }}:noavx512-${{ needs.prepare.outputs.vllm_version }} \\" >> $GITHUB_STEP_SUMMARY
          echo "  --model facebook/opt-125m" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Check build status
        if: needs.build.result == 'failure'
        run: |
          echo "::error::One or more Docker builds failed"
          exit 1
