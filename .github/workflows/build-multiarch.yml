name: Build Multi-Arch vLLM CPU Wheels

on:
  workflow_dispatch:
    inputs:
      vllm_version:
        description: 'vLLM version to build (e.g., 0.11.2)'
        required: true
        type: string
      python_versions:
        description: 'Python versions: "auto" to detect from vLLM, or specify (e.g., 3.10-3.13, 3.12)'
        required: false
        type: string
        default: 'auto'
      variants:
        description: 'Variants to build (noavx512, avx512, avx512vnni, avx512bf16, amxbf16, all)'
        required: false
        type: string
        default: 'noavx512'
      platforms:
        description: 'Platforms to build'
        required: true
        type: choice
        options:
          - 'linux/amd64'
          - 'linux/arm64'
          - 'all'
        default: 'all'
      skip_pypi:
        description: 'Skip PyPI publishing'
        required: false
        type: boolean
        default: false
      skip_github_release:
        description: 'Skip GitHub release creation'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (no actual publish)'
        required: false
        type: boolean
        default: false

jobs:
  # Build on AMD64 (x86_64)
  build-amd64:
    name: Build AMD64 (${{ github.event.inputs.variants }})
    if: github.event.inputs.platforms == 'linux/amd64' || github.event.inputs.platforms == 'all'
    runs-on: ubuntu-latest
    timeout-minutes: 240

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies and Python
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 python3-pip python3-venv \
            build-essential gcc g++ \
            cmake ninja-build ccache \
            libnuma-dev numactl jq

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ccache
            ~/.cache/uv
          key: amd64-${{ github.event.inputs.variants }}-${{ hashFiles('build_config.json') }}
          restore-keys: amd64-

      - name: Build wheels
        run: |
          echo "Building with Python versions: ${{ github.event.inputs.python_versions }}"
          ./build_wheels.sh \
            --variant="${{ github.event.inputs.variants }}" \
            --vllm-versions="${{ github.event.inputs.vllm_version }}" \
            --python-versions="${{ github.event.inputs.python_versions }}" \
            --output-dir=dist

      - name: List built wheels
        run: |
          echo "=== AMD64 wheels ==="
          mkdir -p dist/linux_amd64
          if find dist -name "*.whl" 2>/dev/null | grep -q .; then
            find dist -name "*.whl" -exec ls -lh {} \;
            echo ""
            echo "Directory structure:"
            ls -laR dist/
          else
            echo "ERROR: No wheels found in dist/"
            ls -laR dist/ 2>/dev/null || echo "dist/ directory is empty or doesn't exist"
            exit 1
          fi

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-amd64
          path: |
            dist/**/*.whl
            dist/*.whl
          retention-days: 30
          if-no-files-found: error

  # Build on ARM64 (aarch64) - Native runner, no QEMU
  build-arm64:
    name: Build ARM64 (vllm-cpu only)
    if: github.event.inputs.platforms == 'linux/arm64' || github.event.inputs.platforms == 'all'
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 300

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies and Python
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3 python3-pip python3-venv \
            build-essential gcc g++ \
            cmake ninja-build ccache \
            libnuma-dev numactl jq

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ccache
            ~/.cache/uv
          key: arm64-vllm-cpu-${{ hashFiles('build_config.json') }}
          restore-keys: arm64-

      - name: Build wheels
        run: |
          # ARM64 only supports vllm-cpu (noavx512) variant
          echo "Building with Python versions: ${{ github.event.inputs.python_versions }}"
          echo "Architecture: $(uname -m)"
          echo "Platform: $(uname -a)"
          ./build_wheels.sh \
            --variant=noavx512 \
            --vllm-versions="${{ github.event.inputs.vllm_version }}" \
            --python-versions="${{ github.event.inputs.python_versions }}" \
            --output-dir=dist

      - name: List built wheels
        run: |
          echo "=== ARM64 wheels ==="
          echo "Looking for wheels in dist/ and build/ directories..."
          echo ""
          echo "=== dist/ directory ==="
          find dist -type f -name "*.whl" 2>/dev/null || echo "No wheels in dist/"
          ls -laR dist/ 2>/dev/null || echo "dist/ doesn't exist"
          echo ""
          echo "=== build/ directory (workspace) ==="
          find build -type f -name "*.whl" 2>/dev/null || echo "No wheels in build/"
          ls -laR build/ 2>/dev/null | head -100 || echo "build/ doesn't exist"
          echo ""
          # Check if wheels exist anywhere
          if find dist -name "*.whl" 2>/dev/null | grep -q .; then
            echo "SUCCESS: Wheels found in dist/"
            find dist -name "*.whl" -exec ls -lh {} \;
          else
            echo "ERROR: No wheels found in dist/"
            echo "Checking if wheels were left in build workspace..."
            find . -name "*.whl" -type f 2>/dev/null | head -20 || echo "No .whl files found anywhere"
            exit 1
          fi

      - name: Upload wheel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wheels-arm64
          path: |
            dist/**/*.whl
            dist/*.whl
          retention-days: 30
          if-no-files-found: error

  # Publish all wheels to PyPI using test_and_publish.sh
  publish:
    name: Publish to PyPI
    needs: [build-amd64, build-arm64]
    if: |
      always() &&
      github.event.inputs.skip_pypi != 'true' &&
      (needs.build-amd64.result == 'success' || needs.build-amd64.result == 'skipped') &&
      (needs.build-arm64.result == 'success' || needs.build-arm64.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip jq unzip
          pip3 install twine

      - name: Download AMD64 wheels
        if: needs.build-amd64.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: wheels-amd64
          path: dist/

      - name: Download ARM64 wheels
        if: needs.build-arm64.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: wheels-arm64
          path: dist/

      - name: List all wheels
        run: |
          echo "=========================================="
          echo "All wheels to publish:"
          echo "=========================================="
          mkdir -p dist
          find dist -name "*.whl" -exec ls -lh {} \; || echo "No wheels found"
          echo ""
          echo "Total: $(find dist -name '*.whl' 2>/dev/null | wc -l) wheels"

      - name: Verify and publish wheels
        if: github.event.inputs.dry_run != 'true'
        run: |
          # Use test_and_publish.sh with --skip-build to verify and publish existing wheels
          # The script handles wheel verification, token selection, and upload

          # Detect Python versions from existing wheels
          echo "Detecting Python versions from built wheels..."
          WHEEL_PY_VERSIONS=$(find dist -name "*.whl" -type f | sed -n 's/.*-cp\([0-9]*\)-cp.*/\1/p' | sort -u | while read v; do echo "3.${v#3}"; done | tr '\n' ',' | sed 's/,$//')
          echo "Detected Python versions from wheels: $WHEEL_PY_VERSIONS"

          # Detect platforms from existing wheels
          echo "Detecting platforms from built wheels..."
          WHEEL_PLATFORMS=""
          if find dist -name "*aarch64*.whl" -type f | grep -q .; then
            WHEEL_PLATFORMS="linux/arm64"
          fi
          if find dist -name "*x86_64*.whl" -type f | grep -q .; then
            if [[ -n "$WHEEL_PLATFORMS" ]]; then
              WHEEL_PLATFORMS="all"
            else
              WHEEL_PLATFORMS="linux/amd64"
            fi
          fi
          echo "Detected platforms from wheels: ${WHEEL_PLATFORMS:-all}"

          ./test_and_publish.sh \
            --skip-build \
            --skip-github \
            --variant="${{ github.event.inputs.variants }}" \
            --vllm-versions="${{ github.event.inputs.vllm_version }}" \
            --python-versions="${WHEEL_PY_VERSIONS:-auto}" \
            --platform="${WHEEL_PLATFORMS:-all}" \
            --dist-dir=dist
        env:
          # Variant-specific tokens (one per PyPI package)
          PYPI_TOKEN_CPU: ${{ secrets.PYPI_TOKEN_CPU }}
          PYPI_TOKEN_AVX512: ${{ secrets.PYPI_TOKEN_AVX512 }}
          PYPI_TOKEN_AVX512VNNI: ${{ secrets.PYPI_TOKEN_AVX512VNNI }}
          PYPI_TOKEN_AVX512BF16: ${{ secrets.PYPI_TOKEN_AVX512BF16 }}
          PYPI_TOKEN_AMXBF16: ${{ secrets.PYPI_TOKEN_AMXBF16 }}
          # Fallback token (optional, used if variant-specific token not set)
          PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}

      - name: Dry run - verify wheels only
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "DRY RUN - Verifying wheels without publishing:"

          # Detect Python versions from existing wheels
          WHEEL_PY_VERSIONS=$(find dist -name "*.whl" -type f | sed -n 's/.*-cp\([0-9]*\)-cp.*/\1/p' | sort -u | while read v; do echo "3.${v#3}"; done | tr '\n' ',' | sed 's/,$//')
          echo "Detected Python versions from wheels: $WHEEL_PY_VERSIONS"

          # Detect platforms from existing wheels
          WHEEL_PLATFORMS=""
          if find dist -name "*aarch64*.whl" -type f | grep -q .; then
            WHEEL_PLATFORMS="linux/arm64"
          fi
          if find dist -name "*x86_64*.whl" -type f | grep -q .; then
            if [[ -n "$WHEEL_PLATFORMS" ]]; then
              WHEEL_PLATFORMS="all"
            else
              WHEEL_PLATFORMS="linux/amd64"
            fi
          fi
          echo "Detected platforms from wheels: ${WHEEL_PLATFORMS:-all}"

          ./test_and_publish.sh \
            --skip-build \
            --skip-github \
            --dry-run \
            --variant="${{ github.event.inputs.variants }}" \
            --vllm-versions="${{ github.event.inputs.vllm_version }}" \
            --python-versions="${WHEEL_PY_VERSIONS:-auto}" \
            --platform="${WHEEL_PLATFORMS:-all}" \
            --dist-dir=dist

  # Create GitHub Release
  github-release:
    name: Create GitHub Release
    needs: [build-amd64, build-arm64, publish]
    if: |
      always() &&
      github.event.inputs.skip_github_release != 'true' &&
      github.event.inputs.dry_run != 'true' &&
      (needs.build-amd64.result == 'success' || needs.build-amd64.result == 'skipped') &&
      (needs.build-arm64.result == 'success' || needs.build-arm64.result == 'skipped')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: dist/
          pattern: wheels-*
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.vllm_version }}
          name: vLLM CPU v${{ github.event.inputs.vllm_version }}
          files: dist/**/*.whl
          body: |
            ## vLLM CPU Wheels v${{ github.event.inputs.vllm_version }}

            > **Note:** Download the `.whl` files below. The "Source code" archives are auto-generated by GitHub and not needed for installation.

            ### Packages
            - `vllm-cpu` - Base build (x86_64 + ARM64)
            - `vllm-cpu-avx512` - AVX512 optimized (x86_64)
            - `vllm-cpu-avx512vnni` - AVX512 + VNNI (x86_64)
            - `vllm-cpu-avx512bf16` - AVX512 + BF16 (x86_64)
            - `vllm-cpu-amxbf16` - AMX optimized (x86_64)

            ### Installation
            ```bash
            pip install vllm-cpu==${{ github.event.inputs.vllm_version }}
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Summary
  summary:
    name: Build Summary
    needs: [build-amd64, build-arm64, publish, github-release]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Summary
        run: |
          echo "=========================================="
          echo "Multi-Arch Build Summary"
          echo "=========================================="
          echo "vLLM Version: ${{ github.event.inputs.vllm_version }}"
          echo "Python versions: ${{ github.event.inputs.python_versions }}"
          echo "Platforms: ${{ github.event.inputs.platforms }}"
          echo "Variants: ${{ github.event.inputs.variants }}"
          echo ""
          echo "Build Results:"
          echo "  AMD64: ${{ needs.build-amd64.result }}"
          echo "  ARM64: ${{ needs.build-arm64.result }}"
          echo ""
          echo "Publish: ${{ needs.publish.result }}"
          echo "GitHub Release: ${{ needs.github-release.result }}"
          echo "=========================================="

          # Fail if builds failed
          if [[ "${{ needs.build-amd64.result }}" == "failure" ]] || [[ "${{ needs.build-arm64.result }}" == "failure" ]]; then
            echo "::error::One or more builds failed"
            exit 1
          fi
